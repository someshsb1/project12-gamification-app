@model List<Gamification.UI.Models.Message> // Note that the model is a list of chat messages

@{
    var currentUserId = ViewBag.CurrentUserId;
    var receiverId = ViewBag.ReceiverId;
    var receiverName = ViewBag.ReceiverName; 
    var currentUserName = ViewBag.CurrentName;
}

<div style="height: 100%; width: 100%; display: flex; flex-direction: column; justify-content: space-between;">
    <div>
        <a href="@Url.Action("Chats", "Home")" class="btn btn-primary">Back to Chats</a>

        <div style="width:100%; margin-bottom: auto;">
            @if (Model == null || !Model.Any())
            {
                <div class="mt-3">
                    <div class="alert alert-primary alert-dismissible" role="alert">
                        Nothing found yet!
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>
            }
            else
            {   
                <div style="width:100%; max-height: 80vh; overflow-y: scroll; margin-bottom: auto;">
                    @foreach (var message in Model)
                    {
                        <div >
                                @if (message.SenderID == currentUserId) {
                                    <div class="card mt-3 bg-primary p-2 ml-auto" style="width:fit-content; max-width: 50%;  margin-right:0; margin-left: auto">
                                        <div class="text-sm fw-sm text-end text-white" style="font-size: x-small;">
                                            @message.Timestamp @currentUserName
                                        </div>
                                        <div class="text-white  text-end">@message.Content</div>
                                    </div>
                                } else {
                                    <div class="card mt-3 bg-secondary p-2" style="width:fit-content; max-width: 50%;">
                                        <div class="fw-sm text-sm text-white" style="font-size: x-small;">
                                            @message.Timestamp @receiverName
                                        </div>
                                        <div class="text-white" style="width:fit-content;">@message.Content</div>
                                    </div>
                                }
                        </div>
                    }
                </div>
                
            }
        </div>
    </div>


    <div class="container mt-2">
        <div class="row">
            <div class="col-md-12">
                <form id="chat-form">
                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." />
                        <button type="submit" class="btn text-white" id="send-button" style="background-color: green;">
                            <i class="bx bx-send text-white"></i> Send
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Add this JavaScript at the bottom of your ChatDetails view -->

<script>
    $(document).ready(function () {
        $("#chat-form").submit(function (e) {
            e.preventDefault();
            var messageContent = $("#chat-input").val();

            if (messageContent.trim() !== "") {
                var currentUserId = "@ViewBag.CurrentUserId";
                var receiverId = "@ViewBag.ReceiverId";
                var messageData = {
                    Content: messageContent,
                    SenderID: currentUserId,
                    ReceiverID: receiverId,
                    Timestamp: new Date().toISOString()
                };

                $.ajax({
                    url: "@Url.Action("SendMessage", "Home")",
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(messageData),
                    success: function (response) {
                        $("#chat-input").val("");

                        // Reload the page to fetch the updated messages
                        location.reload();
                    },
                    error: function (error) {
                        console.log("Error: " + error);
                    }
                });
            }
        });
    });
</script>



